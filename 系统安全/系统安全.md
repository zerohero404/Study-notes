# 系统安全防御
## 1.常见攻击手段
- 拒绝服务（DOS）
  - 通过大量访问请求使服务器资源耗尽，无法向正常用户处理请求连接
  - 常见解决手段：使用云服务商的流量清洗功能
- 口令破解
  - 常用攻击手法俗称“跑字典”
  - 常用解决方案：设置登录错误次数限制
- 已知漏洞
  - 通过已知漏洞进行数据获取或提权
  - 常用解决方案：定时更新防御性补丁
- 欺骗权限用户
  - 又称社会工程学，通过欺骗权限用户得到授权资格的方式

## 2.常见的安全防御设备
- 基础类防火墙：主要实现包过滤防火墙
- IDS 类防火墙：入侵检测系统，提供报告和事后监督为主
- IPS 类防火墙：入侵防御系统，分析数据包内容，根据模式匹配去阻断非法访问
- 主动安全类防火墙：对特定服务类型进行专项防御，常见设备有waf、daf

## 3.基础类防护墙
- 什么是防火墙
  - 工作在主机边缘或者网络边缘处对数据报文进行检测，并且能够根据事先定义好的规则，对数据报文进行相应处理的模块
- 防火墙的分类
  - 结构
    - 软件：iptables
    - 硬件：深信服 、 网御 、 华为
  - 工作机制
    - 包过滤防火墙：源地址、目的地址、源端口、目标端口、连接状态
    - 应用层防火墙：URL
  - 模块
    - 内核态：netfilter
    - 用户态：iptables
- Iptables 工作结构<br>
 <img width="476" height="337" alt="系统安全-01" src="https://github.com/user-attachments/assets/428b32a4-af69-489a-9bcf-6759eece96bc" /><br>

- Iptables 经历的构造变化<br>
 <img width="533" height="181" alt="系统安全-02" src="https://github.com/user-attachments/assets/ab3d301f-6fb6-4ae6-b5b1-5864d11e211c" /><br>

- 四表五链
    - 四表（规则表）
      - raw：状态跟踪
      - mangle：标记
      - nat：实现地址转换
      - filter：过滤
  - 五链（规则链）
      - 入站：INPUT
      - 出站：OUTPUT
      - 转发：FORWARD
      - 路由前应用规则：修改目标地址 PREROUTING
      - 路由后应用规则：修改源地址 POSTROUTING
  - 防火墙链表结构<br>
  <img width="558" height="294" alt="系统安全-03" src="https://github.com/user-attachments/assets/f9ec9305-438d-4cbf-990e-8cbe3d459ef1" /><br>
  
- 防火墙相关顺序
  - 规则匹配顺序：由上至下，匹配即停止
  - 表应用顺序：raw>mangle>nat>filter
  - 链应用顺序
    - 入站：PREROUTING>INPUT
    - 出站：OUTPUT>POSTROUTING
    - 转发：PREROUTING>FORWARD>POSTROUTING
- 链表匹配顺序示意图<br>
<img width="538" height="278" alt="系统安全-04" src="https://github.com/user-attachments/assets/2815c94c-0b7c-4e77-8fba-b02306eab8a1" /><br>
  - 入站数据流向
    - 网络A > raw:PREROUTING > mangle:PREROUTING > nat:PREROUTING > 路由选择 > mangle:INPUT > filter:INPUT > 本机的应用进程
  - 出站数据流向
    - 本机的应用进程 > 路由选择 > raw:OUTPUT > mangle:OUTPUT > nat:OUTPUT > filter:OUTPUT > mangle:POSTROUTING > nat:POSTROUTING > 网络B
  - 转发数据流向
    - 网络A > raw:PREROUTING > mangle:PREROUTING > nat:PREROUTING > 路由选择 > mangle:FORWARD > filter: FORWARD > mangle:POSTROUTING > nat:POSTROUTING > 网络B

## 4.Iptables 语法规则
- 书写规则
  - 语法构成：iptables   [-t 表名]   选项  [链名]   [条件]   [-j 控制类型]
  - 注意事项
    - 不指定表名时，默认指 filter 表
    - 不指定链名时，默认指表内的所有链
    - 除非设置链的默认策略，否则必须指定匹配条件
    - 选项、链名、控制类型使用大写字母，其余均为小写
- 常见选项<br>
<img width="612" height="353" alt="系统安全-05" src="https://github.com/user-attachments/assets/99ae0552-b453-4407-9d38-d1ef6259891e" /><br>
- 常见动作类型
  - ACCEPT：允许通过
  - DROP：直接丢弃，不给出任何回应
  - REJECT：拒绝通过，必要时会给出提示
  - LOG：记录日志信息，然后传给下一条规则继续匹配
  - SNAT：修改数据包源地址
  - DNAT：修改数据包目的地址
  - REDIRECT：重定向
- 代码演示示例

```bash
iptables -t filter -L
# 查看过滤表中的所有规则链
iptables -t filter -A INPUT -p tcp -j ACCEPT
# 当 TCP 协议请求入站允许通过，并且把这条规则放在规则链的最下方
iptables -t filter -L -n
# 以数字形式显示过滤表中的所有规则链
iptables -t filter -L -n -v
# 以数字形式显示过滤表中的所有规则链并且显示过滤报文条数和过滤报文包的字节大小，以便查看那条规则过滤信息较多，方便把这条规则放在规则链上方，提高效率
iptables -t filter -I INPUT -p udp -j ACCEPT
# 当 UDP 协议请求入站允许通过，并且把这条规则放在规则链的最上方
iptables -t filter -I INPUT 2 -p icmp -j ACCEPT
# 当 ICMP 协议请求入站允许通过，并且把这条规则放在规则链的第二条
iptables -t filter -L –line-numbers
# 查看过滤表中的所有规则链,并且在规则链前方添加序号
iptables -t filter -D INPUT 4
# 删除过滤表中的入站规则链的第四条规则
iptables -t filter -F
# 删除过滤表的所有规则
iptables -t filter -I INPUT -p tcp -j ACCEPT –dport 22
# 当 TCP 协议请求通过 22 端口入站允许通过，并且把这条规则放在规则链的第一条
iptables -t filter -I INPUT -p tcp -j ACCEPT –dport 80
# 当 TCP 协议请求通过 80 端口入站允许通过，并且把这条规则放在规则链的第一条
iptables -t filter -P INPUT DROP
# 修改过滤表中的入站规则链的默认规则为 DROP（直接丢弃，不给出任何回应）
```

## 5.配型类型分类
### 5.1通用匹配
- 适用条件
  - 可直接使用，不依赖于其他条件或扩展
  - 包括网络协议、IP 地址、网络接口等条件
- 常见的通用匹配选项
  - 协议匹配：-p 协议名
  - 地址匹配：-s  源地址、-d 目的地址
  - 接口匹配：-i 入站网卡、-o 出站网卡
- 代码演示示例
```bash
iptables -A FORWARD -s 192.168.1.11 -j REJECT
# 在 filter 规则表的 FORWARD（转发）链最下面添加一条源地址为 192.168.1.11就拒绝的规则
 iptables -I INPUT -s 10.20.30.0/24 -j DROP
# 在 filter 规则表的 INPUT（入站）链的最上面添加一条源地址是 10.20.30 网段的就 DROP（丢弃）的规则
iptables -I INPUT -p icmp -j DROP
# 在 filter 规则表的 INPUT（入站）链的最上面添加一条入站协议是 icmp 协议就 DROP（丢弃）的规则
 iptables -A FORWARD -p ! icmp -j ACCEPT
# 在 filter 规则表的 FORWARD（转发）链最下面添加一条入站协议不是 icmp 协议就 ACCEPT（允许）的规则
iptables -A INPUT -i eth1 -s 172.16.0.0/12 -j DROP
# 在 filter 规则表的INPUT（入站）链的最下面添加一条入站网卡是 eth1、源地址是 172.16.0.0/12 就 DROP（丢弃）的规则
```

### 5.2 隐含匹配
- 适用条件
  - 要求以特定的协议匹配作为前提
  - 包括端口、TCP 标记、ICMP 类型等条件
- 常用的隐含匹配选项
  - 端口匹配：–sport 源端口、–dport 目的端口
  - ICMP 类型匹配：–icmp-type ICMP 类型
- 代码演示示例
```bash
iptables -A FORWARD -s 192.168.4.0/24 -p udp –dport 53 -j ACCEPT
# 在 filter 规则表的 FORWARD（转发））链的最下面添加一条源地址是 192.168.4.0/24网段，使用的是udp协议，目标端口是53就 ACCEPT（允许）的规则
iptables -A INPUT -p icmp –icmp-type 3 -j ACCEPT
# 在 filter 规则表的 INPUT（入站）链的最下面添加一条如果 ping 不通对方主机则返回错误的规则，默认 ping 不通不会返回错误信息
iptables -A INPUT -p icmp –icmp-type 0 -j ACCEPT
# 在 filter 规则表的 INPUT（入站）链的最下面添加一条只允许此服务器 ping 别的服务器，不允许别的服务器 ping 此服务器的规则
```

### 5.3 显式匹配
- 适用条件
  - 要求以“-m 扩展模块”的形式明确指出类型
  - 包括多端口、MAC 地址、IP 范围、数据包状态等条件
- 常用的显式匹配选项
  - 多端口匹配
    - -m multiport   –sport  源端口列表
    - -m multiport   –dport  目的端口列表
  - IP 范围匹配
    - -m iprange –src-range IP 范围
  - MAC 地址匹配
    - -m mac –mac1-source MAC 地址
  - 状态匹配
    - -m state –state 连接状态
- 代码演示示例
```bash
iptables -A INPUT -p tcp -m multiport –dport 25,80,110,143 -j ACCEPT
# 在 filter 规则表的 INPUT（入站）链的最下面添加一个目的端口列表（25,80,110,143），如果入站请求是这个目的端口列表中的端口就 ACCEPT（允许）的规则
iptables -A FORWARD -p tcp -m iprange –src-range 192.168.4.21-192.168.4.28 -j ACCEPT
# 在 filter 规则表的FORWARD（转发））链的最下面添加一个IP范围（192.168.4.21-192.168.4.28），如果转发请求的源 IP 地址在这个 IP 地址范围内就ACCEPT（允许）的规则
 iptables -A INPUT -m mac –mac-source 00:0c:29:c0:55:3f -j DROP
# 在 filter 规则表的 INPUT（入站）链的最下面添加一条如果入站请求 MAC 地址是 00:0c:29:c0:55:3f 就 DROP（丢弃）的规则
iptables -I INPUT -p tcp -m state –state NEW,ESTABLISHED,RELATED -j ACCEPT
# 在 filter 规则表的 INPUT（入站）链的最上面添加一条连接状态 NEW（新）、ESTABLISHED（已建立）、RELATED（有关）就 ACCEPT（允许）的规则
```

### 5.4 NAT  规则
- SNAT 规则
  - SNAT 策略的典型应用环境：局域网主机共享单个公网 IP 地址接入 Internet
  - SNAT 策略的原理
    - 源地址转换，Source Network Address Translatio
    - 修改数据包的源地址
  - SNAT 网络拓扑<br>
  <img width="612" height="301" alt="系统安全-06" src="https://github.com/user-attachments/assets/40f840ce-b4d8-4b2b-8455-c03cb0565021" /><br>
- 启动 SNAT 转换代码记录
  - 局域网各主机正确设置 IP 地址/子网掩码
  - 局域网各主机正确设置默认网关地址
  - Linux 网关支持 IP 路由转发
  - 步骤演示
    - 需要两块网卡，eth0 和 eth1，eth0 为内网网卡（192.168.1.2），eth1 为外网网卡（218.29.30.31）
    - 局域网主机要把网关设置为网关服务器的 IP 地址
    - 网关服务器需要开启路由转发
      - vim /etc/sysctl.conf
        - 将 net.ipv4.ip_forward = 0 修改为 net.ipv4.ip_forward = 1 # 开启路由转发
      - sysctl -p # 刷新配置文件
    - iptables -F # 清空防火墙规则
    - iptables -t nat -A POSTROUTING -s 192.168.1.0/24（内网网段） -o eth1（外网网卡） -j SNAT --to-source 218.29.30.31（公网 IP）
    - service iptables save # 保存防火墙配置
  
- 如果公网 IP 频繁更换可以使用 MASQUERADE —— 地址伪装
  - 适用于外网 IP 地址 非固定的情况
  - 对于 ADSL 拨号连接，接口通常为 ppp0、ppp1
  - 将 SNAT 规则改为 MASQUERADE 即可
  - 步骤演示
    - 局域网主机要把网关设置为网关服务器的 IP 地址
    - 网关服务器需要开启路由转发
      - vim /etc/sysctl.conf
        - 将 net.ipv4.ip_forward = 0 修改为 net.ipv4.ip_forward = 1 # 开启路由转发
      - sysctl -p # 刷新配置文件
      - iptables -F # 清空防火墙规则
    - iptables -t nat -A POSTROUTING -s 192.168.1.0/24（内网网段） -o eth1（外网网卡） -j MASQUERADE
    - service iptables save # 保存防火墙配置






























