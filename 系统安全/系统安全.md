```markdown
## 02. 系统安全防御

### 2.1 常见攻击手段

#### 拒绝服务（DOS）
通过大量访问请求使服务器资源耗尽，无法向正常用户处理请求连接  
常见解决手段：使用云服务商的流量清洗功能

#### 口令破解
常用攻击手法俗称“跑字典”  
常用解决方案：设置登录错误次数限制

#### 已知漏洞
通过已知漏洞进行数据获取或提权  
常用解决方案：定时更新防御性补丁

#### 欺骗权限用户
又称社会工程学，通过欺骗权限用户得到授权资格的方式

---

### 2.2 常见的安全防御设备

| 类型 | 说明 |
|------|------|
| 基础类防火墙 | 主要实现包过滤防火墙 |
| IDS 类防火墙 | 入侵检测系统，提供报告和事后监督为主 |
| IPS 类防火墙 | 入侵防御系统，分析数据包内容，根据模式匹配阻断非法访问 |
| 主动安全类防火墙 | 对特定服务类型进行专项防御，常见设备有 WAF、DAF |

---

### 2.3 基础类防护墙

#### 什么是防火墙
工作在主机边缘或者网络边缘处对数据报文进行检测，并根据事先定义好的规则处理数据报文的模块

#### 防火墙的分类

**结构**
- 软件：iptables
- 硬件：深信服 、 网御 、 华为

**工作机制**
- 包过滤防火墙：源地址、目的地址、源端口、目标端口、连接状态
- 应用层防火墙：URL

**模块**
- 内核态：netfilter
- 用户态：iptables

#### Iptables 工作结构图
（略）

#### 四表五链

**四表（规则表）**
- raw：状态跟踪
- mangle：标记
- nat：地址转换
- filter：过滤

**五链（规则链）**
- 入站：INPUT
- 出站：OUTPUT
- 转发：FORWARD
- 路由前规则：PREROUTING
- 路由后规则：POSTROUTING

#### 防火墙规则顺序
- 规则匹配顺序：由上至下，匹配即停止
- 表应用顺序：raw > mangle > nat > filter
- 链应用顺序：  
  - 入站：PREROUTING > INPUT  
  - 出站：OUTPUT > POSTROUTING  
  - 转发：PREROUTING > FORWARD > POSTROUTING

#### 数据流向示意
- 入站：A网络 → PREROUTING → 路由 → INPUT → 应用
- 出站：应用 → OUTPUT → POSTROUTING → B网络
- 转发：A网络 → PREROUTING → FORWARD → POSTROUTING → B网络

---

### 2.4 Iptables 语法规则

**规则格式**
```

iptables [-t 表名] 选项 [链名] [条件] [-j 控制类型]

````

**注意**
- 默认表：filter
- 默认匹配所有链
- 未设置默认策略必须指定条件
- 大写：选项、链名、控制类型

#### 常见动作类型
| 动作 | 说明 |
|------|------|
| ACCEPT | 允许通过 |
| DROP | 丢弃无响应 |
| REJECT | 拒绝并提示 |
| LOG | 记录日志后继续匹配 |
| SNAT | 修改源地址 |
| DNAT | 修改目的地址 |
| REDIRECT | 重定向 |

#### 示例代码
```bash
iptables -t filter -L
iptables -t filter -A INPUT -p tcp -j ACCEPT
iptables -t filter -L -n -v
iptables -t filter -I INPUT -p udp -j ACCEPT
iptables -t filter -I INPUT 2 -p icmp -j ACCEPT
iptables -t filter -L --line-numbers
iptables -t filter -D INPUT 4
iptables -t filter -F
iptables -t filter -I INPUT -p tcp --dport 22 -j ACCEPT
iptables -t filter -P INPUT DROP
````

---

### 2.5 配型类型分类

#### 2.5.1 通用匹配

可直接使用：协议、IP、网络接口

示例：

```bash
iptables -I INPUT -p icmp -j DROP
iptables -A INPUT -i eth1 -s 172.16.0.0/12 -j DROP
```

#### 2.5.2 隐含匹配

基于特定协议前提，如端口、ICMP 类型

示例：

```bash
iptables -A INPUT -p icmp --icmp-type 0 -j ACCEPT
```

#### 2.5.3 显式匹配

以 `-m` 指定扩展模块，如多端口、IP范围、MAC、连接状态

示例：

```bash
iptables -A INPUT -p tcp -m state --state NEW,ESTABLISHED,RELATED -j ACCEPT
```

---

### 2.5.4 NAT 规则

#### SNAT

典型环境：局域网共享外网 IP
作用：修改数据包源地址

示例：

```bash
iptables -t nat -A POSTROUTING -s 192.168.1.0/24 -o eth1 -j SNAT --to-source 218.29.30.31
```

动态外网 IP 使用：

```bash
iptables -t nat -A POSTROUTING -s 192.168.1.0/24 -o eth1 -j MASQUERADE
```

#### DNAT

典型环境：发布内网服务器到公网
作用：修改数据包目标地址

示例：

```bash
iptables -t nat -A PREROUTING -i eth1 -d 218.29.30.31 -p tcp --dport 80 -j DNAT --to-destination 192.168.1.6
```

#### Iptables 其他命令

```bash
iptables-save > backup.iptables
iptables-restore < backup.iptables
service iptables save
```

---

### 2.5.5 CentOS7 使用 Iptables

```bash
rpm -e --nodeps firewalld
yum -y install iptables-services
systemctl start iptables
systemctl enable iptables
```

---

### 2.5.6 常用 Iptables 配置脚本

```bash
#!/bin/bash 
PATH=/bin:/sbin:/usr/bin:/usr/sbin:/usr/local/bin:/usr/local/sbin:~/bin
export PATH

function support_distro(){
    if [ -z "`egrep -i "centos" /etc/issue`" ];then
        echo "Sorry,iptables script only support centos system now."
        exit 1
    fi
}

support_distro

# 获取SSH端口
if grep "^Port" /etc/ssh/sshd_config>/dev/null;then
    sshdport=`grep "^Port" /etc/ssh/sshd_config | sed "s/Port\s//g"`
else
    sshdport=22
fi

# 获取DNS服务器
if [ -s /etc/resolv.conf ];then
    nameserver1=`grep nameserver /etc/resolv.conf | awk 'NR==1{print $2}'`
    nameserver2=`grep nameserver /etc/resolv.conf | awk 'NR==2{print $2}'`
fi

IPT="/sbin/iptables"
$IPT --delete-chain
$IPT --flush

$IPT -P INPUT DROP
$IPT -P FORWARD DROP
$IPT -P OUTPUT ACCEPT
$IPT -A INPUT -i lo -j ACCEPT

$IPT -A INPUT -m state --state RELATED,ESTABLISHED -j ACCEPT
$IPT -A OUTPUT -m state --state RELATED,ESTABLISHED -j ACCEPT

$IPT -I INPUT -p tcp --dport 80 -m connlimit --connlimit-above 10 -j DROP

$IPT -A INPUT -p tcp --dport 80 -j ACCEPT
$IPT -A INPUT -p tcp --dport 873 -j ACCEPT
$IPT -A INPUT -p tcp --dport 443 -j ACCEPT
$IPT -A INPUT -p tcp --dport 20 -j ACCEPT
$IPT -A INPUT -p tcp --dport 21 -j ACCEPT
$IPT -A INPUT -p tcp --dport 25 -j ACCEPT

$IPT -A INPUT -p tcp --dport $sshdport -j ACCEPT

$IPT -A INPUT -p icmp --icmp-type 8 -j ACCEPT
$IPT -A INPUT -p icmp --icmp-type 11 -j ACCEPT

[ ! -z "$nameserver1" ] && $IPT -A OUTPUT -p udp -d $nameserver1 --dport 53 -j ACCEPT
[ ! -z "$nameserver2" ] && $IPT -A OUTPUT -p udp -d $nameserver2 --dport 53 -j ACCEPT

service iptables save
service iptables restart
```

---

`markdown`
