# 1.Mysql 主从备份
- 1.1 首先修改主服务器 /etc/my.cnf 配置文件<br>
&ensp;vim /etc/my.cnf<br>
&ensp;&ensp;添加两条选项，开启二进制日志<br>
&ensp;&ensp;log-bin=mysql-bin # 启用二进制日志<br>
&ensp;&ensp;server-id=24 # 服务器的 id 号<br>
- 1.2 再修改从服务器 /etc/my.cnf 配置文件<br>
&ensp;vim /etc/my.cnf<br>
&ensp;&ensp;添加两条选项，开启二进制日志<br>
&ensp;&ensp;log-bin=mysql-bin # 启用二进制日志<br>
&ensp;&ensp;server-id=23 # 服务器的 id 号
 <img width="866" height="373" alt="Linux：网络服务_59" src="https://github.com/user-attachments/assets/3868f7ca-f69f-484a-b95c-dca4057775bd" /><br>
- 1.3 登录主服务器的 mysql 数据库
&ensp;mysql -uroot -p
&ensp;在主服务器上授权
```bash
mysql>grant replication slave on *.* to asd(登录的用户名)@’192.168.64.23(从服务器的 IP 地址)’ identified by ‘123456(密码)’;
```
 <img width="661" height="135" alt="Linux：网络服务_60" src="https://github.com/user-attachments/assets/f8cae1c9-c881-4235-8aca-fa2241988ea2" /><br>

- 1.4 mysql>show master status; # 查看日志文件名和大小<br>
 <img width="392" height="130" alt="Linux：网络服务_61" src="https://github.com/user-attachments/assets/eed2481d-efb8-48ee-a856-fcbd3230ac6b" />

- 1.5 登录从服务器的 mysql 数据库<br>
&ensp;mysql -uroot -p<br>
&ensp;在从服务器保存授权的信息<br>
```bash
mysql>change master to master_user=’asd(主服务器授权的用户名)’,master_password=’123456(主服务器授权的密码)’,master_host=’192.168.64.24(主服务器的 IP 地址)’,master_log_file=’mysql-bin.000003(主服务器日志文件名)’,master_log_pos=257(主服务器日志文件大小);
```
 <img width="323" height="131" alt="Linux：网络服务_62" src="https://github.com/user-attachments/assets/8a3d2156-90c7-4cf7-807e-cc0d6f11bbce" /><br>
- 1.6 开启主从备份<br>
&ensp;mysql>start slave;<br>
&ensp;查看是否开启<br>
&ensp;show slave status\G;<br>
 <img width="692" height="423" alt="Linux：网络服务_63" src="https://github.com/user-attachments/assets/b2b15a52-702c-4188-805d-a7ae2948d042" /><br>
- 1.7 测试
 <img width="1188" height="397" alt="Linux：网络服务_64" src="https://github.com/user-attachments/assets/6f207d3c-fb78-46a9-84c7-0c64ef5a9af7" />
 <img width="1152" height="304" alt="Linux：网络服务_65" src="https://github.com/user-attachments/assets/6777e1fb-0c06-411d-a945-2d69e2c5e064" />

- 1.8 授权信息内容文件路径<br>
&ensp;/var/lib/mysql/master.info<br>
 <img width="684" height="556" alt="Linux：网络服务_66" src="https://github.com/user-attachments/assets/8cd3f22e-3560-42ac-84c0-f2c7245f1c8b" />


# 2.主主备份
- 2.1 先把数据库服务给停掉<br>
- 2.2 先以服务器 1 为主，服务器 2 为从配置一遍修改服务器 1 的配置文件<br>
&ensp;vim /etc/my.cnf<br>
 <img width="622" height="432" alt="Linux：网络服务_67" src="https://github.com/user-attachments/assets/9f394cce-2594-4869-94bc-1750409e0783" /><br>
- 2.3 再在服务器 2 的做同样的配置<br>
 <img width="1334" height="449" alt="Linux：网络服务_68" src="https://github.com/user-attachments/assets/eea3368b-be20-4566-980c-93d25432af38" /><br>
- 2.4 启动数据库服务<br>
 <img width="610" height="120" alt="Linux：网络服务_69" src="https://github.com/user-attachments/assets/074ada29-b61c-4d70-97b6-612fd1650d49" /><br>
- 2.5 在服务器 1 上授权

```bash
mysql -uroot -p
mysql>grant replication slave on *.* to asd(登录的用户名)@’192.168.64.23(服务器 2 的 IP 地址)’ identified by ‘123456(密码)’;
```
 <img width="647" height="177" alt="Linux：网络服务_70" src="https://github.com/user-attachments/assets/6b1fd051-660c-4721-92db-116457c3ee6a" /><br>

&ensp;输入show master status;  查看日志文件名称和大小<br>

- 2.6 再在服务器 2 上保存授权信息

```bash
mysql -uroot -p
mysql>change master to master_user=’asd(主服务器授权的用户名)’,master_password=’123456(主服务器授权的密码)’,master_host=’192.168.64.24(主服务器的 IP 地址)’,master_log_file=’mysql-bin.000003(主服务器日志文件名)’,master_log_pos=106(主服务器日志文件大小);
```
- 2.7 开启主从备份(在两台机器上都要执行命令)
&ensp;mysql>start slave;
- 2.8 再以服务器 2 为主，服务器 1 为从配置一遍
- 2.9 启动数据库<br>
<img width="610" height="120" alt="Linux：网络服务_69" src="https://github.com/user-attachments/assets/c36bccce-61e6-46c5-bc98-84fe3bdafe70" /><br>
- 2.10 在服务器 2 上授权
```bash
mysql -uroot -p
mysql>change master to master_user=’asd(主服务器授权的用户名)’,master_password=’123456(主服务器授权的密码)’,master_host=’192.168.64.23(主服务器的 IP 地址)’,master_log_file=’mysql-bin.000003(主服务器日志文件名)’,master_log_pos=106(主服务器日志文件大小);
```
<img width="1304" height="280" alt="Linux：网络服务_73" src="https://github.com/user-attachments/assets/6e2b3cfe-ebe3-4b1a-b358-ffa05eeffd10" /><br>
- 2.11 开启主从备份
&ensp;mysql>start slave;
- 2.12 服务器 1 和服务器 2 都执行 start slave; 之后就完成主主备份,然后进行测试
<img width="1119" height="666" alt="Linux：网络服务_74" src="https://github.com/user-attachments/assets/3b8fbdbd-62fe-49f3-9518-a2fe31f4a23e" /><br>

# 3. 一主多从
- 3.1 主服务器配置<br>
&ensp;开启二进制日志，并启动 mysql<br>
<img width="571" height="228" alt="Linux：网络服务_75" src="https://github.com/user-attachments/assets/732a495a-6155-4acf-9db0-9be45c154474" /><br>
&ensp;在主服务器上授权<br>
<img width="771" height="228" alt="Linux：网络服务_76" src="https://github.com/user-attachments/assets/35fae308-2020-49e4-94a7-63fc456b1d4f" /><br>

-3.2 从服务器配置
&ensp;开启二进制日志，并启动 mysql<br>
<img width="585" height="323" alt="Linux：网络服务_77" src="https://github.com/user-attachments/assets/a58678ec-f784-41af-bc68-181a81ddc02d" /><br>
&ensp;保存授权信息<br>
<img width="1111" height="432" alt="Linux：网络服务_78" src="https://github.com/user-attachments/assets/c858c78c-752d-4345-9ae6-bef51862e97c" /><br>
&ensp;有多少台从服务器就把上面的两个步骤重复多少次，注意 server-id 不能相同

- 3.3 测试
<img width="1155" height="392" alt="Linux：网络服务_79" src="https://github.com/user-attachments/assets/40761fb8-ee08-4006-8305-cfd889af2d1c" />

# 4.多主一从
- 4.1 主服务器 1 配置<br>
&ensp;开启二进制日志，启动服务<br>
&ensp;vim /et/my.cnf<br>
<img width="573" height="226" alt="Linux：网络服务_80" src="https://github.com/user-attachments/assets/32058f44-5255-46dd-b7e0-66426f31c147" /><br>
&ensp;授权<br>

```bash
mysql>grant replication slave on *.* to zhangxu（用户名）@’192.168.220.30（从服务器IP地址）’ identified by ‘123456（密码）’;
```
<img width="654" height="264" alt="Linux：网络服务_81" src="https://github.com/user-attachments/assets/c0a1b852-c55b-4d90-aeac-8072f3b3e15b" />

- 4.2 主服务器 2 配置<br>
&ensp;开启二进制日志，启动服务<br>
&ensp;vim /et/my.cnf<br>
<img width="592" height="217" alt="Linux：网络服务_82" src="https://github.com/user-attachments/assets/e086e9cc-f550-40a0-b6bd-ba6e1687d293" /><br>
&ensp;授权<br>

```bash
mysql>grant replication slave on *.* to zhangxu（用户名）@’192.168.220.30（从服务器IP地址）’ identified by ‘123456（密码）’;
```
<img width="671" height="265" alt="Linux：网络服务_83" src="https://github.com/user-attachments/assets/4d6a9e35-c1c9-43e6-a65f-ea0f5fbbfedd" /><br>

- 4.3 从服务器配置<br>
&ensp;修改从服务器的数据库配置文件
&ensp;vim /etc/my.cnf 添加以下选项

```bash
[mysqld_multi]]
mysqld=/usr/bin/mysqld_safe
mysqladmin=/usr/bin/mysqladmin
log=/tmp/multi.log

[mysqld10]
port=3306
datadir=/var/lib/mysql-one/
pid-file=/var/lib/mysql-one/mysqld.pid
socket=/var/lib/mysql-one/mysql.sock
user=mysql
server-id=30

[mysqld20]
port=3307
datadir=/var/lib/mysql-two/
pid-file=/var/lib/mysql-two/mysqld.pid
socket=/var/lib/mysql-two/mysql.sock
user=mysql
server-id=30
```

<img width="597" height="500" alt="Linux：网络服务_84" src="https://github.com/user-attachments/assets/d4bb2db0-9abc-43a8-a886-68fdf5df6164" /><br>

- 4.4 初始化数据库，生成目录 mysql-one,mysql-two
```bash
mysql_install_db –datadir=/var/lib/mysql-one –user=mysql
```
<img width="572" height="200" alt="Linux：网络服务_85" src="https://github.com/user-attachments/assets/da398b0f-bb24-4db8-ae04-8791a33e38e0" /><br>
```bash
mysql_install_db –datadir=/var/lib/mysql-two –user=mysql
```
<img width="539" height="197" alt="Linux：网络服务_86" src="https://github.com/user-attachments/assets/6feaedc6-a3ed-4eb2-83d0-40506a987186" /><br>
&ensp;验证是否成功初始化可以进入 /var/lib/ 下查看是否创建了 mysql-one 和 mysql-two 这两个文件夹

- 4.5 设置 mysqla,mysqlb 目录及以下文件的属主为 mysql(防止出现权限问题）
```bash
chown -R mysql /var/lib/mysql-one
chown -R mysql /var/lib/mysql-two
```
- 4.6 启动从服务器线程
```bash
mysqld_multi –defaults-file=/etc/my.cnf start 10
# 这个 start 后面的 10 就是 my.cnf 里面 [mysqld10] 设置的10
mysqld_multi –defaults-file=/etc/my.cnf start 20
```
- 4.7 登录并保存授权信息
&ensp;登录 [mysqld10] 这个数据库
```bash
mysql -P 3306 -S /var/lib/mysql-one/mysql.sock
mysql>change master to master_user=’zhangxu’,master_password=’123456′,master_host=’192.168.220.10（主服务1的IP地址）’,master_log_file=’mysql-bin.000001（主服务1的日志文件名称）’,master_log_pos=345（主服务1的日志文件大小）;
mysql>start slave;
```

&ensp;登录 [mysqld20] 这个数据库
```bash
mysql -P 3307 -S /var/lib/mysql-two/mysql.sock
mysql>change master to master_user=’zhangxu’,master_password=’123456′,master_host=’192.168.220.20（主服务2的IP地址）’,master_log_file=’mysql-bin.000001（主服务2的日志文件名称）’,master_log_pos=345（主服务2的日志文件大小）;
mysql>start slave;
```

- 4.8 MySQL 的多主一从就部署完成了<br>
&ensp;在主服务器 1 上创建一个库看看 [mysqld10] 这个数据库是否同步<br>
&ensp;在主服务器 2 上创建一个库看看 [mysqld20] 这个数据库是否同步<br>

# 5.读写分离
- 5.1  MySQL 中间件-Amoeba<br>
&ensp;中间件：一种提供在不同技术、不同的软件之间共享资源的程序，更大化了利用了数据库的性能，可以无限扩展（注：真实环境中并非如此）<br>
&ensp;数据库的中间件<br>
&ensp;&ensp;mysql proxy (官方版本) 性能低，需要 lua 脚本<br>
&ensp;&ensp;atlas 性能低，响应时间长<br>
&ensp;&ensp;amoeba 陈思儒研发的<br>

- 5.2配置读写分离<br>
&ensp;首先先配置一套主从服务器，配置方法参考 1.Mysql 主从备份<br>
&ensp;然后下载 amoeba-mysql-1.3.1-BETA 和 jdk-7u40-linux-x64<br>
&ensp;上传到 amoeba 服务器<br>
&ensp;安装 gcc 环境<br>

```bash
yum -y install gcc*
```

&ensp;创建一个文件夹存放 amoeba 相关的文件

```bash
mkdir /amoeba
```

&ensp;将 jdk-7u40-linux-x64 解压到 /amoeba 文件夹中改名 jdk

```bash
tax -xf jdk-7u40-linux-x64.gz
cp -a jdk-7u40-linux-x64 /amoeba/jdk
```

&ensp;声明 java 写出来的程序如何调用 （/etc/profile）

```bash
vim /etc/profile # 添加三行
export JAVA_HOME=/amoeba/jdk
export PATH=$JAVA_HOME/bin:$PATH
export CLASSPATH=.:$JAVA_HOME/bin/tools.jar:$JAVA_HOME/lib/dt.jar:$CLASSPATH
```

 <img width="952" height="732" alt="Linux：网络服务_87" src="https://github.com/user-attachments/assets/15540440-ff8a-41d8-921c-af95184f4a66" /><br>

&ensp;加载下 /etc/profile

```bash
source /etc/profile
```

&ensp;测试 java 是否安装成功

```bash
java -version
```
 <img width="824" height="98" alt="Linux：网络服务_88" src="https://github.com/user-attachments/assets/8ee18ad9-b2e3-4a82-b76b-b31168b50205" /><br>
 
&ensp;安装 amoeba
&ensp;&ensp;将 amoeba-mysql-1.3.1-BETA 解压到 /usr/local/amoeba

```bash
chmod -R +x /usr/local/amoeba/bin
```
 <img width="776" height="63" alt="Linux：网络服务_89" src="https://github.com/user-attachments/assets/56b2d3da-8b47-4e83-8371-413629c1df6a" /><br>

&ensp;配置 amoeba

 ```bash
vim /usr/local/amoeba/conf/amoeba.xml
```

&ensp;&ensp;首先 改写 /<server> /</server>区域<br>
 <img width="999" height="619" alt="Linux：网络服务_90" src="https://github.com/user-attachments/assets/18bc4213-518a-4d7a-871e-81b83c51e446" /><br>
&ensp;&ensp;然后改写/<dbServerList> /</dbServerList>区域<br>
 <img width="1056" height="620" alt="Linux：网络服务_91" src="https://github.com/user-attachments/assets/72e18a95-cdfb-4cde-af72-4f8310c8c0a2" /><br>
&ensp;&ensp;# 其中 <property name=”schema”>test</property> 中的 test 为你要同步的数据库名，记得修改<br>
&ensp;&ensp;在将这个 server1 这个标签复制后将 server1 改为 server2<br>
 <img width="894" height="577" alt="Linux：网络服务_92" src="https://github.com/user-attachments/assets/59f27b51-5608-4678-ad4f-92722e509025" /><br>
&ensp;&ensp;再将下面这段文字再复制一份<br>
 <img width="610" height="160" alt="Linux：网络服务_93" src="https://github.com/user-attachments/assets/c4e9ef1d-af3d-444b-b2be-66aaacd19fa7" /><br>
&ensp;&ensp;改为下面两个<br>
 <img width="945" height="157" alt="Linux：网络服务_94" src="https://github.com/user-attachments/assets/0aa6291f-0d10-4938-95fc-194748579cbb" /><br>
 <img width="826" height="165" alt="Linux：网络服务_95" src="https://github.com/user-attachments/assets/2e48981c-3d70-449f-b4cb-ecb29fe25717" /><br>
&ensp;&ensp;# 注意：这上面的 name=”multiPool” 中的 multiPool 可以随意更换，但是记得哪个是写，哪个是读<br>
&ensp;&ensp;再将上面两个读写池名字填写到下面这段文字中<br>
 <img width="796" height="168" alt="Linux：网络服务_96" src="https://github.com/user-attachments/assets/5d82fa0a-0009-403a-b83d-0e21c2cea8e2" /><br>
&ensp;再修改 amoeba 的启动脚本

```bash
vim /usr/local/amoeba/bin/amoeba
# 将-Xss128k 修改为 –Xss256
```

 <img width="991" height="234" alt="Linux：网络服务_97" src="https://github.com/user-attachments/assets/52e62200-88b0-4142-9d59-a38a49f9c99c" /><br>
&ensp;再到主从服务器上登录 mysql 数据库授权 amoeba 能连接主从服务器（主从服务器都这样执行）

```bash
mysql -uroot -p
mysql>grant all on tset（库名）.* to asd（amoeba.xml 填写的用户名）@’192.168.64.23’（amoeba的数据库地址） identified by ‘123456’（amoeba.xml 填写的密码）;
```

&ensp;启动 amoeba

```bash
nohup bash -x /usr/local/amoeba/bin/amoeba &
# 把这个放到后台 退出终端也可以继续运行
```

 <img width="777" height="82" alt="Linux：网络服务_98" src="https://github.com/user-attachments/assets/5e1c3670-4acb-4747-bd8e-8c21d7b1292a" /><br>

&ensp;&ensp;# ps aux | grep amoeba 或者 netstat -antp 查看 8066端口<br>
&ensp;&ensp;查看一下运行的程序 查看到的话就说明程序已经运行了起来,到此读写分离已经成功配置<br>

&ensp;测试<br>
 <img width="766" height="293" alt="Linux：网络服务_99" src="https://github.com/user-attachments/assets/95674063-e63f-477e-b5f3-df09a02157ea" /><br>
&ensp;在主、从服务器上创建表 a1，在主服务器的表中插入数据
 <img width="1110" height="522" alt="Linux：网络服务_100" src="https://github.com/user-attachments/assets/a59773d7-8a67-4c68-8ea8-5e987321af3d" /><br>
&ensp;之后在 amoeba 服务器登录测试
&ensp;&ensp;读取池的效果
<img width="581" height="590" alt="Linux：网络服务_101" src="https://github.com/user-attachments/assets/d3dbaf93-d56b-4630-8a6b-cd61653cc285" /><br>
&ensp;&ensp;写入池效果
<img width="663" height="585" alt="Linux：网络服务_102" src="https://github.com/user-attachments/assets/ce136d65-abd5-41b3-bf0b-c1023a2ac4cf" /><br>

&ensp;&ensp;# 以上测试纯粹为了实验效果，在实际生产中，主从开启，主服务器上写入的数据也会同步到从服务器中
